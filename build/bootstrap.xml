<!--Цели phing, которые используются при первоначальном разворачивании приложения. Возможны ссылки сюда и при деплое -->
<project name="argilla_bootstrap" basedir="." default="bootstrap">
  <property name="argilla.defaultJsCompiler" value="closure"/>
  <property name="argilla.yiiStorage" value="/usr/local/yii"/>
  <php expression="dirName(getcwd())" returnProperty="projectDirectory"/>

  <target name="bootstrap" depends="symlinkYii, createBaseHtaccess, createDBConfig" />
  <target name="packJS" description="Упаковать JS">
    <exec command="protected/yiic scripts pack" passthru="true"/>
  </target>
  <target name="compileJS" description="Скомпилировать JS" depends="packJS">
    <if>
      <not>
        <isset property="jsCompiler"/>
      </not>
      <then>
        <property name="jsCompiler" value="${argilla.defaultJsCompiler}"/>
      </then>
    </if>
    <echo message="Компилируем javascript компилятором '${jsCompiler}'..."/>
    <if>
      <equals arg1="${jsCompiler}" arg2="yui"/>
      <then>
        <exec command="java -jar build/compilers/yuicompressor.jar js/packed.js>build/tmp/compiled.js"/>
      </then>
    </if>
    <if>
      <equals arg1="${jsCompiler}" arg2="closure"/>
      <then>
        <exec command="java -jar build/compilers/closure.jar --third_party --warning_level QUIET --js js/packed.js --js_output_file build/tmp/compiled.js"/>
      </then>
    </if>

    <!-- проверка результатов компиляции-->
    <if>
      <not>
        <available file="build/tmp/compiled.js"/>
      </not>
      <then>
        <fail message="Компиляция javascript не прошла: файл не создан"/>
      </then>
    </if>
    <filesize file="build/tmp/compiled.js" propertyName="compiledJsFileSize"/>
    <if>
      <equals arg1="${compiledJsFileSize}" arg2="0"/>
      <then>
        <fail message="Компиляция javascript не прошла: файл имеет нулевой размер"/>
      </then>
    </if>

    <php expression="floor(${compiledJsFileSize}/1024)" returnProperty="compiledJsFileSize"/>
    <echo message="Компиляция завершена. Файл build/tmp/compiled.js размером ${compiledJsFileSize}K. Копируем в js/compiled.js..."/>

    <copy file="build/tmp/compiled.js" tofile="js/compiled.js" overwrite="true"/>
  </target>

  <target name="symlinkYii" depends="checkYiiAvailability">
    <if>
      <not><available property="checkSymlink"  file="${projectDirectory}/yii" followSymlinks="true"/></not>
      <then>
        <input message="Симлинк ${argilla.yiiStorage}/${argilla.yiiVersion} на yii не создан, желаете создать? (y/n)" defaultValue="y" propertyName="confirmCreateYiiSymlink"/>
        <if>
          <equals arg1="${confirmCreateYiiSymlink}" arg2="y"/>
          <then><exec checkreturn="true" passthru="true" command="ln -s ${argilla.yiiStorage}/${argilla.yiiVersion} ${projectDirectory}/yii"/></then>
        </if>
      </then>
      <else><echo message="Симлинк с именем yii уже существует"/></else>
    </if>
  </target>
  <target name="checkYiiAvailability" depends="getYiiVersion">
    <if>
      <not>
        <available property="checkDir" file="${argilla.yiiStorage}/${argilla.yiiVersion}/framework" type="dir"/>
      </not>
      <then>
        <fail message="Yii версии '${argilla.yiiVersion}' не найден по пути '${argilla.yiiStorage}/${argilla.yiiVersion}'"/>
      </then>
    </if>
  </target>
  <target name="getYiiVersion">
    <php expression="require('protected/config/version.php');" returnProperty="argilla.yiiVersion"/>
  </target>

  <taskdef name="createHtaccessFile" classname="build.tasks.CreateBaseHtaccessTask"/>
  <target name="createBaseHtaccess">
    <if>
      <not><available property="checkFile" file="${projectDirectory}/.htaccess" type="file"/></not>
      <then>
        <input message="Файл ${projectDirectory}/.htaccess не создан, желаете создать? (y/n)" defaultValue="y" propertyName="confirmCreateBaseHtaccess"/>
        <if>
          <equals arg1="${confirmCreateBaseHtaccess}" arg2="y"/>
          <then><createHtaccessFile dir="${projectDirectory}/"/></then>
        </if>
      </then>
      <else><echo message="Файл ${projectDirectory}/.htaccess уже существует"></echo></else>
    </if>
  </target>

  <target name="createDBConfig">
    <if>
      <not><available property="checkFile" file="protected\config\db.php" type="file"/></not>
      <then>
        <php expression="preg_replace('/[^\w]/', '_',basename('${projectDirectory}'))" returnProperty="defaultDbName"/>
        <input message="Введите имя базы" propertyName="dbName" defaultValue="${defaultDbName}"/>
        <input message="Введите префикс таблиц" propertyName="dbTablePrefix" defaultValue="${defaultDbName}_"/>
        <input message="Введите имя пользователя" propertyName="dbUser" defaultValue="prog"/>
        <input message="Введите пароль" propertyName="dbPassword" defaultValue="123"/>
        <copy file="protected\config\db.php.sample" tofile="protected\config\db.php">
          <filterchain>
            <replaceregexp>
              <regexp pattern="DATABASE_NAME" replace="${dbName}" ignoreCase="true"/>
              <regexp pattern="DATABASE_PREFIX" replace="${dbTablePrefix}" ignoreCase="true"/>
              <regexp pattern="DATABASE_USER" replace="${dbUser}" ignoreCase="true"/>
              <regexp pattern="DATABASE_PASSWORD" replace="${dbPassword}" ignoreCase="true"/>
            </replaceregexp>
          </filterchain>
        </copy>
      </then>
      <else><echo message="Файл ${projectDirectory}/protected\config\db.php уже существует"></echo></else>
    </if>
  </target>

</project>

